@page "/mis-pedidos"
@using Microsoft.EntityFrameworkCore
@inject UsuarioService UsuarioService
@inject TechStoreContext DbContext
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Mis Pedidos - TechStore</PageTitle>

@if (UsuarioService.UsuarioActual == null)
{
    <div class="empty-state">
        <div class="empty-icon">ðŸ”’</div>
        <h2>Debes iniciar sesiÃ³n</h2>
        <p>Para ver tus pedidos, necesitas estar autenticado</p>
        <a href="/login" class="btn-primary">Iniciar SesiÃ³n</a>
    </div>
}
else
{
    <div class="pedidos-container">
        <div class="page-header">
            <h1>ðŸ“¦ Mis Pedidos</h1>
            <p class="subtitle">Historial completo de todas tus compras en TechStore</p>
        </div>

        @if (!ordenes.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">ðŸ“¦</div>
                <h2>No tienes pedidos aÃºn</h2>
                <p>Explora nuestro catÃ¡logo y realiza tu primera compra</p>
                <a href="/" class="btn-primary">Ver CatÃ¡logo</a>
            </div>
        }
        else
        {
            <div class="ordenes-lista">
                @foreach (var orden in ordenes.OrderByDescending(o => o.FechaCreacion))
                {
                    <div class="orden-card">
                        <div class="orden-header">
                            <div class="orden-info">
                                <h3>Pedido #@orden.Id</h3>
                                <p class="orden-fecha">@orden.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                            <div class="orden-estado">
                                <span class="estado-badge estado-@orden.Estado.ToString().ToLower()">
                                    @GetEstadoIcon(orden.Estado) @orden.Estado.ToString()
                                </span>
                            </div>
                        </div>

                        <div class="orden-detalles">
                            <div class="orden-items">
                                @foreach (var item in orden.Items)
                                {
                                    <div class="orden-item">
                                        <img src="@item.ProductoTecnologico?.ImagenUrl" alt="@item.ProductoTecnologico?.Nombre" />
                                        <div class="item-info">
                                            <h4>@item.ProductoTecnologico?.Nombre</h4>
                                            <p>Cantidad: @item.Cantidad</p>
                                            @if (item.EspecificacionesSeleccionadas.Any())
                                            {
                                                <div class="item-specs-small">
                                                    @foreach (var spec in item.EspecificacionesSeleccionadas)
                                                    {
                                                        <span class="spec-tag">@spec.Especificacion?.Nombre</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="item-precio">
                                            @((item.PrecioTotal * item.Cantidad).ToString("C2"))
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="orden-resumen">
                                <div class="resumen-row">
                                    <span>Cliente:</span>
                                    <span>@orden.NombreCliente</span>
                                </div>
                                <div class="resumen-row">
                                    <span>Email:</span>
                                    <span>@orden.EmailCliente</span>
                                </div>
                                <div class="resumen-row">
                                    <span>DirecciÃ³n:</span>
                                    <span>@orden.DireccionEntrega</span>
                                </div>
                                @if (!string.IsNullOrEmpty(orden.NotasOrden))
                                {
                                    <div class="resumen-row">
                                        <span>Notas:</span>
                                        <span>@orden.NotasOrden</span>
                                    </div>
                                }
                                <hr />
                                <div class="resumen-row total-row">
                                    <strong>Total:</strong>
                                    <strong>@orden.PrecioTotal.ToString("C2")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private List<Orden> ordenes = new();

    protected override async Task OnInitializedAsync()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            ordenes = await DbContext.Ordenes
                .Where(o => o.UsuarioId == UsuarioService.UsuarioActual.Id)
                .Include(o => o.Items)
                    .ThenInclude(i => i.ProductoTecnologico)
                .Include(o => o.Items)
                    .ThenInclude(i => i.EspecificacionesSeleccionadas)
                        .ThenInclude(e => e.Especificacion)
                .ToListAsync();
        }
    }

    private string GetEstadoIcon(EstadoOrden estado)
    {
        return estado switch
        {
            EstadoOrden.Pendiente => "â³",
            EstadoOrden.Confirmada => "âœ“",
            EstadoOrden.EnProceso => "ðŸ”„",
            EstadoOrden.Enviada => "ðŸšš",
            EstadoOrden.Entregada => "âœ…",
            EstadoOrden.Cancelada => "âŒ",
            _ => "ðŸ“¦"
        };
    }
}
