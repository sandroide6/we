@page "/mis-pedidos"
@using Microsoft.EntityFrameworkCore
@inject TechStoreContext DbContext
@rendermode InteractiveServer

<PageTitle>Mis Pedidos - TechStore</PageTitle>

<div class="orders-container">
    <h1>ðŸ“¦ Mis Pedidos</h1>

    @if (!ordenes.Any())
    {
        <div class="empty-orders">
            <div class="empty-icon">ðŸ“‹</div>
            <h2>No tienes pedidos aÃºn</h2>
            <p>Explora nuestro catÃ¡logo y realiza tu primera compra</p>
            <a href="/" class="btn-primary">Ver CatÃ¡logo</a>
        </div>
    }
    else
    {
        <div class="orders-list">
            @foreach (var orden in ordenes.OrderByDescending(o => o.FechaCreacion))
            {
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <h3>Pedido #@orden.Id</h3>
                            <p class="order-date">@orden.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="order-status">
                            <span class="status-badge">âœ“ Confirmado</span>
                        </div>
                    </div>

                    <div class="order-details">
                        <div class="detail-row">
                            <strong>Cliente:</strong>
                            <span>@orden.NombreCliente</span>
                        </div>
                        <div class="detail-row">
                            <strong>Email:</strong>
                            <span>@orden.EmailCliente</span>
                        </div>
                        <div class="detail-row">
                            <strong>DirecciÃ³n:</strong>
                            <span>@orden.DireccionEntrega</span>
                        </div>
                    </div>

                    <div class="order-items">
                        <h4>Productos:</h4>
                        @foreach (var item in orden.Items)
                        {
                            <div class="order-item">
                                <div class="item-info">
                                    <span class="item-name">@item.ProductoTecnologico?.Nombre</span>
                                    <span class="item-qty">Ã— @item.Cantidad</span>
                                </div>
                                @if (item.EspecificacionesSeleccionadas.Any())
                                {
                                    <div class="item-specs-list">
                                        @foreach (var spec in item.EspecificacionesSeleccionadas)
                                        {
                                            <span class="spec-tag">@spec.Especificacion?.Nombre</span>
                                        }
                                    </div>
                                }
                                <div class="item-price">$@(item.PrecioTotal * item.Cantidad).ToString("N2")</div>
                            </div>
                        }
                    </div>

                    <div class="order-total">
                        <strong>Total:</strong>
                        <strong class="total-amount">$@orden.PrecioTotal.ToString("N2")</strong>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Orden> ordenes = new();

    protected override async Task OnInitializedAsync()
    {
        ordenes = await DbContext.Ordenes
            .Include(o => o.Items)
                .ThenInclude(i => i.ProductoTecnologico)
            .Include(o => o.Items)
                .ThenInclude(i => i.EspecificacionesSeleccionadas)
                    .ThenInclude(e => e.Especificacion)
            .ToListAsync();
    }
}
