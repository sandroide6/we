@page "/perfil"
@using System.ComponentModel.DataAnnotations
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Mi Perfil - TechStore</PageTitle>

@if (UsuarioService.UsuarioActual == null)
{
    <div class="empty-state">
        <div class="empty-icon">üîí</div>
        <h2>Debes iniciar sesi√≥n</h2>
        <p>Para acceder a tu perfil, necesitas estar autenticado</p>
        <a href="/login" class="btn-primary">Ir a Login</a>
    </div>
}
else
{
    <div class="perfil-container">
        <div class="perfil-header">
            <div class="avatar-section">
                <img src="@UsuarioService.UsuarioActual.AvatarUrl" alt="@UsuarioService.UsuarioActual.NombreCompleto" class="avatar-large" />
                <h1>@UsuarioService.UsuarioActual.NombreCompleto</h1>
                <p class="user-email">@UsuarioService.UsuarioActual.Email</p>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert @(esError ? "alert-error" : "alert-success")">
                @mensaje
            </div>
        }

        <div class="perfil-grid">
            <div class="perfil-card">
                <h2>üìã Informaci√≥n Personal</h2>
                
                <EditForm Model="@perfilEdit" OnValidSubmit="GuardarPerfil">
                    <DataAnnotationsValidator />

                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre</label>
                            <InputText @bind-Value="perfilEdit.Nombre" class="form-input" placeholder="Tu nombre" />
                        </div>

                        <div class="form-group">
                            <label>Apellido</label>
                            <InputText @bind-Value="perfilEdit.Apellido" class="form-input" placeholder="Tu apellido" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìß Email</label>
                        <InputText @bind-Value="perfilEdit.Email" type="email" class="form-input" disabled />
                        <small>El email no se puede cambiar</small>
                    </div>

                    <div class="form-group">
                        <label>üìû Tel√©fono</label>
                        <InputText @bind-Value="perfilEdit.Telefono" class="form-input" placeholder="+57 300 123 4567" />
                    </div>

                    <div class="form-group">
                        <label>üìç Direcci√≥n</label>
                        <InputTextArea @bind-Value="perfilEdit.Direcci√≥n" class="form-input" rows="2" placeholder="Tu direcci√≥n de env√≠o" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>üèôÔ∏è Ciudad</label>
                            <InputText @bind-Value="perfilEdit.Ciudad" class="form-input" placeholder="Tu ciudad" />
                        </div>

                        <div class="form-group">
                            <label>üåç Pa√≠s</label>
                            <InputText @bind-Value="perfilEdit.Pais" class="form-input" placeholder="Tu pa√≠s" />
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" disabled="@procesando">
                        @if (procesando)
                        {
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>üíæ Guardar Cambios</span>
                        }
                    </button>
                </EditForm>
            </div>

            <div class="perfil-card">
                <h2>üìä Estad√≠sticas de Cuenta</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <div class="stat-label">Miembro desde</div>
                            <div class="stat-value">@UsuarioService.UsuarioActual.FechaRegistro.ToString("dd MMM yyyy")</div>
                        </div>
                    </div>

                    <div class="stat-box">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-info">
                            <div class="stat-label">Total de pedidos</div>
                            <div class="stat-value">@(UsuarioService.UsuarioActual.Ordenes?.Count ?? 0)</div>
                        </div>
                    </div>

                    <div class="stat-box">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-info">
                            <div class="stat-label">Total gastado</div>
                            <div class="stat-value">@UsuarioService.UsuarioActual.TotalGastado.ToString("C2")</div>
                        </div>
                    </div>

                    @if (UsuarioService.UsuarioActual.UltimoLogin.HasValue)
                    {
                        <div class="stat-box">
                            <div class="stat-icon">üïê</div>
                            <div class="stat-info">
                                <div class="stat-label">√öltimo acceso</div>
                                <div class="stat-value">@UsuarioService.UsuarioActual.UltimoLogin.Value.ToString("dd MMM HH:mm")</div>
                            </div>
                        </div>
                    }
                </div>

                <hr class="divider" />

                <h3>üîê Cambiar Contrase√±a</h3>

                <EditForm Model="@cambioContrase√±a" OnValidSubmit="CambiarContrase√±a">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Contrase√±a Actual</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aActual" type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>

                    <div class="form-group">
                        <label>Nueva Contrase√±a</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aNueva" type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>

                    <div class="form-group">
                        <label>Confirmar Nueva Contrase√±a</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aConfirm" type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>

                    <button type="submit" class="btn-secondary" disabled="@procesandoContrase√±a">
                        @if (procesandoContrase√±a)
                        {
                            <span>Cambiando...</span>
                        }
                        else
                        {
                            <span>Cambiar Contrase√±a</span>
                        }
                    </button>
                </EditForm>
            </div>
        </div>

        <div class="perfil-actions">
            <button class="btn-logout" @onclick="Logout">üö™ Cerrar Sesi√≥n</button>
        </div>
    </div>
}

@code {
    private PerfilModel perfilEdit = new();
    private CambioContrase√±aModel cambioContrase√±a = new();
    private string mensaje = "";
    private bool esError = false;
    private bool procesando = false;
    private bool procesandoContrase√±a = false;

    protected override async Task OnInitializedAsync()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            var usuario = await UsuarioService.ObtenerUsuarioPorIdAsync(UsuarioService.UsuarioActual.Id);
            if (usuario != null)
            {
                perfilEdit.Email = usuario.Email;
                perfilEdit.Nombre = usuario.Nombre;
                perfilEdit.Apellido = usuario.Apellido;
                perfilEdit.Telefono = usuario.Telefono;
                perfilEdit.Direcci√≥n = usuario.Direcci√≥n;
                perfilEdit.Ciudad = usuario.Ciudad;
                perfilEdit.Pais = usuario.Pais;
            }
        }
    }

    private async Task GuardarPerfil()
    {
        procesando = true;
        mensaje = "";

        var resultado = await UsuarioService.ActualizarPerfilAsync(
            UsuarioService.UsuarioActual.Id,
            perfilEdit.Nombre,
            perfilEdit.Apellido,
            perfilEdit.Telefono,
            perfilEdit.Direcci√≥n,
            perfilEdit.Ciudad,
            perfilEdit.Pais
        );

        if (resultado)
        {
            mensaje = "‚úì Perfil actualizado correctamente";
            esError = false;
        }
        else
        {
            mensaje = "Error al actualizar el perfil";
            esError = true;
        }

        procesando = false;
    }

    private async Task CambiarContrase√±a()
    {
        procesandoContrase√±a = true;
        mensaje = "";

        if (string.IsNullOrEmpty(cambioContrase√±a.Contrase√±aActual) ||
            string.IsNullOrEmpty(cambioContrase√±a.Contrase√±aNueva) ||
            string.IsNullOrEmpty(cambioContrase√±a.Contrase√±aConfirm))
        {
            mensaje = "Todos los campos de contrase√±a son obligatorios";
            esError = true;
            procesandoContrase√±a = false;
            return;
        }

        if (cambioContrase√±a.Contrase√±aNueva != cambioContrase√±a.Contrase√±aConfirm)
        {
            mensaje = "Las contrase√±as nuevas no coinciden";
            esError = true;
            procesandoContrase√±a = false;
            return;
        }

        var resultado = await UsuarioService.CambiarContrase√±aAsync(
            UsuarioService.UsuarioActual.Id,
            cambioContrase√±a.Contrase√±aActual,
            cambioContrase√±a.Contrase√±aNueva,
            cambioContrase√±a.Contrase√±aConfirm
        );

        if (resultado)
        {
            mensaje = "‚úì Contrase√±a cambiada correctamente";
            esError = false;
            cambioContrase√±a = new();
        }
        else
        {
            mensaje = "Error: Verifica que la contrase√±a actual sea correcta y que la nueva tenga al menos 6 caracteres";
            esError = true;
        }

        procesandoContrase√±a = false;
    }

    private async Task Logout()
    {
        await UsuarioService.LogoutAsync();
        NavigationManager.NavigateTo("/login");
    }

    public class PerfilModel
    {
        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "El formato del email no es v√°lido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "El nombre es requerido")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "El nombre debe tener entre 2 y 50 caracteres")]
        public string Nombre { get; set; } = "";

        [Required(ErrorMessage = "El apellido es requerido")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "El apellido debe tener entre 2 y 50 caracteres")]
        public string Apellido { get; set; } = "";

        [Phone(ErrorMessage = "El formato del tel√©fono no es v√°lido")]
        public string Telefono { get; set; } = "";

        public string Direcci√≥n { get; set; } = "";

        [StringLength(100, ErrorMessage = "La ciudad no puede exceder 100 caracteres")]
        public string Ciudad { get; set; } = "";

        [StringLength(100, ErrorMessage = "El pa√≠s no puede exceder 100 caracteres")]
        public string Pais { get; set; } = "";
    }

    public class CambioContrase√±aModel
    {
        [Required(ErrorMessage = "La contrase√±a actual es requerida")]
        public string Contrase√±aActual { get; set; } = "";

        [Required(ErrorMessage = "La nueva contrase√±a es requerida")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "La contrase√±a debe tener al menos 8 caracteres")]
        public string Contrase√±aNueva { get; set; } = "";

        [Required(ErrorMessage = "Debes confirmar la nueva contrase√±a")]
        [Compare("Contrase√±aNueva", ErrorMessage = "Las contrase√±as no coinciden")]
        public string Contrase√±aConfirm { get; set; } = "";
    }
}
