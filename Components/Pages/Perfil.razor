@page "/perfil"
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Mi Perfil - TechStore</PageTitle>

@if (UsuarioService.UsuarioActual == null)
{
    <div class="empty-state">
        <div class="empty-icon">üîí</div>
        <h2>Debes iniciar sesi√≥n</h2>
        <p>Para acceder a tu perfil, necesitas estar autenticado</p>
        <a href="/login" class="btn-primary">Ir a Login</a>
    </div>
}
else
{
    <div class="perfil-container">
        <h1>üë§ Mi Perfil</h1>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert @(esError ? "alert-error" : "alert-success")">
                @mensaje
            </div>
        }

        <div class="perfil-grid">
            <div class="perfil-card">
                <h2>üìã Informaci√≥n Personal</h2>
                
                <EditForm Model="@perfilEdit" OnValidSubmit="GuardarPerfil">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Nombre</label>
                        <InputText @bind-Value="perfilEdit.Nombre" class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>Apellido</label>
                        <InputText @bind-Value="perfilEdit.Apellido" class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>üìß Email</label>
                        <InputText @bind-Value="perfilEdit.Email" type="email" class="form-input" disabled />
                        <small>El email no se puede cambiar</small>
                    </div>

                    <div class="form-group">
                        <label>üìû Tel√©fono</label>
                        <InputText @bind-Value="perfilEdit.Telefono" class="form-input" placeholder="+34 123 456 789" />
                    </div>

                    <div class="form-group">
                        <label>üìç Direcci√≥n</label>
                        <InputTextArea @bind-Value="perfilEdit.Direcci√≥n" class="form-input" rows="3" placeholder="Tu direcci√≥n de env√≠o" />
                    </div>

                    <button type="submit" class="btn-primary" disabled="@procesando">
                        @if (procesando)
                        {
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>üíæ Guardar Cambios</span>
                        }
                    </button>
                </EditForm>
            </div>

            <div class="perfil-card">
                <h2>üìä Informaci√≥n de Cuenta</h2>
                
                <div class="info-row">
                    <span class="label">Miembro desde:</span>
                    <span class="value">@UsuarioService.UsuarioActual.FechaRegistro.ToString("dd/MM/yyyy")</span>
                </div>

                <div class="info-row">
                    <span class="label">Total de pedidos:</span>
                    <span class="value">@(UsuarioService.UsuarioActual.Ordenes?.Count ?? 0)</span>
                </div>

                @if (UsuarioService.UsuarioActual.UltimoLogin.HasValue)
                {
                    <div class="info-row">
                        <span class="label">√öltimo login:</span>
                        <span class="value">@UsuarioService.UsuarioActual.UltimoLogin.Value.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                }

                <hr />

                <h3>üîê Cambiar Contrase√±a</h3>

                <EditForm Model="@cambioContrase√±a" OnValidSubmit="CambiarContrase√±a">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Contrase√±a Actual</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aActual" type="password" class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>Nueva Contrase√±a</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aNueva" type="password" class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>Confirmar Nueva Contrase√±a</label>
                        <InputText @bind-Value="cambioContrase√±a.Contrase√±aConfirm" type="password" class="form-input" />
                    </div>

                    <button type="submit" class="btn-secondary" disabled="@procesandoContrase√±a">
                        Cambiar Contrase√±a
                    </button>
                </EditForm>
            </div>
        </div>

        <div class="perfil-actions">
            <button class="btn-logout" @onclick="Logout">üö™ Cerrar Sesi√≥n</button>
        </div>
    </div>
}

@code {
    private PerfilModel perfilEdit = new();
    private CambioContrase√±aModel cambioContrase√±a = new();
    private string mensaje = "";
    private bool esError = false;
    private bool procesando = false;
    private bool procesandoContrase√±a = false;

    protected override async Task OnInitializedAsync()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            var usuario = await UsuarioService.ObtenerUsuarioPorIdAsync(UsuarioService.UsuarioActual.Id);
            if (usuario != null)
            {
                perfilEdit.Email = usuario.Email;
                perfilEdit.Nombre = usuario.Nombre;
                perfilEdit.Apellido = usuario.Apellido;
                perfilEdit.Telefono = usuario.Telefono;
                perfilEdit.Direcci√≥n = usuario.Direcci√≥n;
            }
        }
    }

    private async Task GuardarPerfil()
    {
        procesando = true;
        mensaje = "";

        var resultado = await UsuarioService.ActualizarPerfilAsync(
            UsuarioService.UsuarioActual.Id,
            perfilEdit.Nombre,
            perfilEdit.Apellido,
            perfilEdit.Telefono,
            perfilEdit.Direcci√≥n
        );

        if (resultado)
        {
            mensaje = "‚úì Perfil actualizado correctamente";
            esError = false;
        }
        else
        {
            mensaje = "Error al actualizar el perfil";
            esError = true;
        }

        procesando = false;
    }

    private async Task CambiarContrase√±a()
    {
        procesandoContrase√±a = true;
        mensaje = "";

        var resultado = await UsuarioService.CambiarContrase√±aAsync(
            UsuarioService.UsuarioActual.Id,
            cambioContrase√±a.Contrase√±aActual,
            cambioContrase√±a.Contrase√±aNueva,
            cambioContrase√±a.Contrase√±aConfirm
        );

        if (resultado)
        {
            mensaje = "‚úì Contrase√±a cambiada correctamente";
            esError = false;
            cambioContrase√±a = new();
        }
        else
        {
            mensaje = "Error al cambiar la contrase√±a";
            esError = true;
        }

        procesandoContrase√±a = false;
    }

    private async Task Logout()
    {
        await UsuarioService.LogoutAsync();
        NavigationManager.NavigateTo("/login");
    }

    public class PerfilModel
    {
        public string Email { get; set; } = "";
        public string Nombre { get; set; } = "";
        public string Apellido { get; set; } = "";
        public string Telefono { get; set; } = "";
        public string Direcci√≥n { get; set; } = "";
    }

    public class CambioContrase√±aModel
    {
        public string Contrase√±aActual { get; set; } = "";
        public string Contrase√±aNueva { get; set; } = "";
        public string Contrase√±aConfirm { get; set; } = "";
    }
}
