@page "/checkout"
@using Microsoft.EntityFrameworkCore
@implements IDisposable
@inject EstadoPedido EstadoPedido
@inject TechStoreContext DbContext
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Checkout - TechStore</PageTitle>

<div class="checkout-container">
    <h1>üõí Finalizar Compra</h1>

    @if (UsuarioService.UsuarioActual == null)
    {
        <div class="empty-cart">
            <div class="empty-icon">üîí</div>
            <h2>Debes iniciar sesi√≥n</h2>
            <p>Para realizar un pedido, necesitas estar autenticado en TechStore</p>
            <a href="/login" class="btn-primary">Iniciar Sesi√≥n</a>
        </div>
    }
    else if (!EstadoPedido.Items.Any())
    {
        <div class="empty-cart">
            <div class="empty-icon">üõçÔ∏è</div>
            <h2>Tu carrito est√° vac√≠o</h2>
            <p>Explora nuestro cat√°logo y encuentra los productos perfectos para ti</p>
            <a href="/" class="btn-primary">Ver Cat√°logo</a>
        </div>
    }
    else
    {
        <div class="checkout-grid">
            <div class="cart-items">
                <h2>Productos en tu carrito</h2>
                @foreach (var item in EstadoPedido.Items)
                {
                    <div class="cart-item">
                        <img src="@item.ProductoTecnologico?.ImagenUrl" alt="@item.ProductoTecnologico?.Nombre" />
                        <div class="item-details">
                            <h3>@item.ProductoTecnologico?.Nombre</h3>
                            <p class="item-type">@item.ProductoTecnologico?.Tipo.ToString()</p>
                            
                            @if (item.EspecificacionesSeleccionadas.Any())
                            {
                                <div class="item-specs">
                                    <strong>Especificaciones:</strong>
                                    <ul>
                                        @foreach (var spec in item.EspecificacionesSeleccionadas)
                                        {
                                            <li>@spec.Especificacion?.Nombre (+@spec.PrecioEspecificacion.ToString("C2"))</li>
                                        }
                                    </ul>
                                </div>
                            }
                            
                            <div class="item-quantity">
                                <label>Cantidad:</label>
                                <input type="number" 
                                       min="1" 
                                       value="@item.Cantidad" 
                                       @oninput="@((e) => ActualizarCantidad(item, e.Value?.ToString()))" />
                            </div>
                        </div>
                        <div class="item-actions">
                            <div class="item-price">@((item.PrecioTotal * item.Cantidad).ToString("C2"))</div>
                            <button class="btn-remove" @onclick="() => RemoverItem(item)">Eliminar</button>
                        </div>
                    </div>
                }
            </div>

            <div class="order-summary">
                <h2>Resumen del Pedido</h2>
                
                <EditForm Model="@orden" OnValidSubmit="RealizarPedido">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <InputText @bind-Value="orden.NombreCliente" class="form-input" placeholder="Tu nombre" />
                        <ValidationMessage For="@(() => orden.NombreCliente)" />
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <InputText @bind-Value="orden.EmailCliente" class="form-input" type="email" placeholder="tu@email.com" />
                        <ValidationMessage For="@(() => orden.EmailCliente)" />
                    </div>

                    <div class="form-group">
                        <label>Direcci√≥n de Entrega</label>
                        <InputTextArea @bind-Value="orden.DireccionEntrega" class="form-input" rows="3" placeholder="Calle, Ciudad, Pa√≠s" />
                        <ValidationMessage For="@(() => orden.DireccionEntrega)" />
                    </div>

                    <div class="order-total">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>@EstadoPedido.PrecioTotal.ToString("C2")</span>
                        </div>
                        <div class="total-row">
                            <span>Env√≠o:</span>
                            <span>GRATIS</span>
                        </div>
                        <div class="total-row total-final">
                            <strong>Total:</strong>
                            <strong>@EstadoPedido.PrecioTotal.ToString("C2")</strong>
                        </div>
                    </div>

                    <button type="submit" class="btn-checkout" disabled="@procesando">
                        @if (procesando)
                        {
                            <span>Procesando...</span>
                        }
                        else
                        {
                            <span>‚úì Confirmar Pedido</span>
                        }
                    </button>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private Orden orden = new();
    private bool procesando = false;

    protected override void OnInitialized()
    {
        EstadoPedido.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        EstadoPedido.OnChange -= StateHasChanged;
    }

    private void RemoverItem(ItemOrden item)
    {
        EstadoPedido.RemoverItem(item);
    }

    private void ActualizarCantidad(ItemOrden item, string? valor)
    {
        if (int.TryParse(valor, out int cantidad))
        {
            EstadoPedido.ActualizarCantidad(item, cantidad);
        }
    }

    private async Task RealizarPedido()
    {
        procesando = true;

        // Cargar los productos y especificaciones desde la base de datos
        var productosIds = EstadoPedido.Items.Select(i => i.ProductoTecnologicoId).Distinct().ToList();
        var especIds = EstadoPedido.Items
            .SelectMany(i => i.EspecificacionesSeleccionadas)
            .Select(e => e.EspecificacionId)
            .Distinct()
            .ToList();
        
        var productosDb = await DbContext.ProductosTecnologicos
            .Where(p => productosIds.Contains(p.Id))
            .ToDictionaryAsync(p => p.Id);
            
        var especificacionesDb = await DbContext.Especificaciones
            .Where(e => especIds.Contains(e.Id))
            .ToDictionaryAsync(e => e.Id);

        orden.FechaCreacion = DateTime.Now;
        orden.UsuarioId = UsuarioService.UsuarioActual?.Id;
        
        // Crear una copia del pedido con todos los datos cargados para WhatsApp
        var ordenParaWhatsApp = new Orden
        {
            NombreCliente = orden.NombreCliente,
            EmailCliente = orden.EmailCliente,
            DireccionEntrega = orden.DireccionEntrega,
            FechaCreacion = orden.FechaCreacion,
            Items = EstadoPedido.Items.Select(item => new ItemOrden
            {
                ProductoTecnologicoId = item.ProductoTecnologicoId,
                ProductoTecnologico = productosDb.GetValueOrDefault(item.ProductoTecnologicoId),
                Cantidad = item.Cantidad,
                PrecioBaseProducto = item.PrecioBaseProducto,
                EspecificacionesSeleccionadas = item.EspecificacionesSeleccionadas.Select(spec => new EspecificacionOrden
                {
                    EspecificacionId = spec.EspecificacionId,
                    Especificacion = especificacionesDb.GetValueOrDefault(spec.EspecificacionId),
                    PrecioEspecificacion = spec.PrecioEspecificacion
                }).ToList()
            }).ToList()
        };

        // Crear items para guardar en la base de datos (sin referencias de navegaci√≥n)
        orden.Items = EstadoPedido.Items.Select(item => new ItemOrden
        {
            ProductoTecnologicoId = item.ProductoTecnologicoId,
            Cantidad = item.Cantidad,
            PrecioBaseProducto = item.PrecioBaseProducto,
            EspecificacionesSeleccionadas = item.EspecificacionesSeleccionadas.Select(spec => new EspecificacionOrden
            {
                EspecificacionId = spec.EspecificacionId,
                PrecioEspecificacion = spec.PrecioEspecificacion
            }).ToList()
        }).ToList();

        DbContext.Ordenes.Add(orden);
        await DbContext.SaveChangesAsync();

        // Generar mensaje de WhatsApp con detalles del pedido
        var mensajeWhatsApp = GenerarMensajeWhatsApp(ordenParaWhatsApp);
        var numeroWhatsApp = "573003895839"; // Formato internacional de Colombia
        var urlWhatsApp = $"https://wa.me/{numeroWhatsApp}?text={Uri.EscapeDataString(mensajeWhatsApp)}";

        EstadoPedido.LimpiarCarrito();
        
        procesando = false;
        
        // Redirigir a WhatsApp
        NavigationManager.NavigateTo(urlWhatsApp, true);
    }

    private string GenerarMensajeWhatsApp(Orden orden)
    {
        var mensaje = $"¬°Hola! üëã Acabo de realizar un pedido en TechStore\n\n";
        mensaje += $"üìã *Detalles del Pedido*\n";
        mensaje += $"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        mensaje += $"üë§ Cliente: {orden.NombreCliente}\n";
        mensaje += $"üìß Email: {orden.EmailCliente}\n";
        mensaje += $"üìç Direcci√≥n: {orden.DireccionEntrega}\n\n";
        
        mensaje += $"üõí *Productos:*\n";
        var numeroItem = 1;
        decimal totalPedido = 0;
        
        foreach (var item in orden.Items)
        {
            var nombreProducto = item.ProductoTecnologico?.Nombre ?? "Producto";
            var subtotalItem = item.PrecioBaseProducto + item.EspecificacionesSeleccionadas.Sum(e => e.PrecioEspecificacion);
            var totalItem = subtotalItem * item.Cantidad;
            totalPedido += totalItem;
            
            mensaje += $"\n{numeroItem}. {nombreProducto}\n";
            mensaje += $"   ‚Ä¢ Cantidad: {item.Cantidad}\n";
            mensaje += $"   ‚Ä¢ Precio base: {item.PrecioBaseProducto.ToString("C2")}\n";
            
            if (item.EspecificacionesSeleccionadas.Any())
            {
                mensaje += $"   ‚Ä¢ Especificaciones:\n";
                foreach (var spec in item.EspecificacionesSeleccionadas)
                {
                    var nombreSpec = spec.Especificacion?.Nombre ?? "Especificaci√≥n";
                    mensaje += $"     - {nombreSpec} ({spec.PrecioEspecificacion.ToString("C2")})\n";
                }
            }
            
            mensaje += $"   ‚Ä¢ Subtotal: {totalItem.ToString("C2")}\n";
            numeroItem++;
        }
        
        mensaje += $"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        mensaje += $"üí∞ *TOTAL: {totalPedido.ToString("C2")}*\n\n";
        mensaje += $"Pedido realizado el {orden.FechaCreacion.ToString("dd/MM/yyyy HH:mm")}\n\n";
        mensaje += $"Espero su confirmaci√≥n. ¬°Gracias! üòä";
        
        return mensaje;
    }
}
