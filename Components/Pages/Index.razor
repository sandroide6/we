@page "/"
@using Microsoft.EntityFrameworkCore
@inject TechStoreContext DbContext
@inject CarritoService CarritoService
@inject UsuarioService UsuarioService
@rendermode InteractiveServer

<PageTitle>TechStore - Cat√°logo de Productos</PageTitle>

<div class="catalog-header">
    <h1>üöÄ Bienvenido a TechStore</h1>
    <p class="subtitle">Descubre los mejores productos de tecnolog√≠a para tu negocio o proyecto personal</p>
</div>

<div class="search-filter-bar">
    <div class="search-box">
        <input type="text" 
               placeholder="Buscar productos..." 
               @bind="terminoBusqueda" 
               @bind:event="oninput"
               @bind:after="FiltrarProductos"
               class="search-input" />
        <span class="search-icon">üîç</span>
    </div>

    <div class="category-filters">
        <button class="filter-btn @(categoriaSeleccionada == "Todos" ? "active" : "")" @onclick='() => FiltrarCategoria("Todos")'>
            Todos
        </button>
        <button class="filter-btn @(categoriaSeleccionada == "Hardware" ? "active" : "")" @onclick='() => FiltrarCategoria("Hardware")'>
            üíª Hardware
        </button>
        <button class="filter-btn @(categoriaSeleccionada == "Software" ? "active" : "")" @onclick='() => FiltrarCategoria("Software")'>
            üì¶ Software
        </button>
        <button class="filter-btn @(categoriaSeleccionada == "Servicio" ? "active" : "")" @onclick='() => FiltrarCategoria("Servicio")'>
            üõ†Ô∏è Servicios
        </button>
    </div>
</div>

<div class="products-grid">
    @foreach (var producto in productosFiltrados)
    {
        <div class="product-card">
            @if (UsuarioService.UsuarioActual != null)
            {
                <button class="btn-favorito @(productosFavoritos.Contains(producto.Id) ? "activo" : "")" 
                        @onclick="() => ToggleFavorito(producto.Id)">
                    @(productosFavoritos.Contains(producto.Id) ? "‚ù§Ô∏è" : "ü§ç")
                </button>
            }
            
            <div class="product-image" style="background-image: url('@producto.ImagenUrl')"></div>
            <div class="product-content">
                <span class="product-badge">@producto.Tipo.ToString()</span>
                <h3 class="product-title">@producto.Nombre</h3>
                <p class="product-description">@producto.Descripcion</p>
                <div class="product-footer">
                    <div class="product-price">
                        <span class="price-label">Desde</span>
                        <span class="price-value">@producto.PrecioBase.ToString("C2")</span>
                    </div>
                    @if (producto.EspecificacionesDisponibles.Any())
                    {
                        <button class="btn-customize" @onclick="() => MostrarPersonalizacion(producto)">
                            Personalizar
                        </button>
                    }
                    else
                    {
                        <button class="btn-add" @onclick="() => AgregarAlCarrito(producto)">
                            Agregar al Carrito
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@if (productosFiltrados.Count == 0)
{
    <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <h2>No se encontraron productos</h2>
        <p>Intenta con otros t√©rminos de b√∫squeda o categor√≠as</p>
    </div>
}

@if (productoPersonalizar != null)
{
    <div class="modal-overlay" @onclick="CerrarPersonalizacion">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Personaliza tu paquete</h2>
                <button class="btn-close" @onclick="CerrarPersonalizacion">√ó</button>
            </div>
            <div class="modal-body">
                <div class="product-preview">
                    <img src="@productoPersonalizar.ImagenUrl" alt="@productoPersonalizar.Nombre" />
                    <div>
                        <h3>@productoPersonalizar.Nombre</h3>
                        <p>@productoPersonalizar.Descripcion</p>
                        <div class="base-price">Precio base: @productoPersonalizar.PrecioBase.ToString("C2")</div>
                    </div>
                </div>

                <div class="specifications">
                    <h4>Especificaciones y Extras:</h4>
                    @foreach (var spec in productoPersonalizar.EspecificacionesDisponibles)
                    {
                        <label class="spec-option">
                            <input type="checkbox" 
                                   checked="@especificacionesSeleccionadas.Contains(spec)"
                                   @onchange="() => ToggleEspecificacion(spec)" />
                            <span class="spec-name">@spec.Nombre</span>
                            <span class="spec-price">
                                @(spec.PrecioAdicional >= 0 ? "+" : "")@spec.PrecioAdicional.ToString("C2")
                            </span>
                        </label>
                    }
                </div>

                <div class="total-preview">
                    <strong>Total:</strong>
                    <span class="total-amount">
                        @((productoPersonalizar.PrecioBase + especificacionesSeleccionadas.Sum(e => e.PrecioAdicional)).ToString("C2"))
                    </span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CerrarPersonalizacion">Cancelar</button>
                <button class="btn-primary" @onclick="AgregarPersonalizadoAlCarrito">Agregar al Carrito</button>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductoTecnologico> productos = new();
    private List<ProductoTecnologico> productosFiltrados = new();
    private HashSet<int> productosFavoritos = new();
    private string categoriaSeleccionada = "Todos";
    private string terminoBusqueda = "";
    private ProductoTecnologico? productoPersonalizar;
    private HashSet<Especificacion> especificacionesSeleccionadas = new();

    protected override async Task OnInitializedAsync()
    {
        productos = await DbContext.ProductosTecnologicos
            .Include(p => p.EspecificacionesDisponibles)
            .ToListAsync();
        productosFiltrados = productos;

        if (UsuarioService.UsuarioActual != null)
        {
            var favoritos = await UsuarioService.ObtenerFavoritosAsync(UsuarioService.UsuarioActual.Id);
            productosFavoritos = favoritos.Select(f => f.Id).ToHashSet();
        }
    }

    private void FiltrarCategoria(string categoria)
    {
        categoriaSeleccionada = categoria;
        FiltrarProductos();
    }

    private void FiltrarProductos()
    {
        productosFiltrados = productos
            .Where(p => 
                (categoriaSeleccionada == "Todos" || p.Tipo.ToString() == categoriaSeleccionada) &&
                (string.IsNullOrWhiteSpace(terminoBusqueda) || 
                 p.Nombre.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) ||
                 p.Descripcion.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private void AgregarAlCarrito(ProductoTecnologico producto)
    {
        CarritoService.AgregarProducto(producto);
    }

    private void MostrarPersonalizacion(ProductoTecnologico producto)
    {
        productoPersonalizar = producto;
        especificacionesSeleccionadas.Clear();
    }

    private void CerrarPersonalizacion()
    {
        productoPersonalizar = null;
        especificacionesSeleccionadas.Clear();
    }

    private void ToggleEspecificacion(Especificacion spec)
    {
        if (especificacionesSeleccionadas.Contains(spec))
            especificacionesSeleccionadas.Remove(spec);
        else
            especificacionesSeleccionadas.Add(spec);
    }

    private void AgregarPersonalizadoAlCarrito()
    {
        if (productoPersonalizar != null)
        {
            var item = new ItemOrden
            {
                ProductoTecnologicoId = productoPersonalizar.Id,
                ProductoTecnologico = productoPersonalizar,
                Cantidad = 1,
                PrecioBaseProducto = productoPersonalizar.PrecioBase,
                EspecificacionesSeleccionadas = especificacionesSeleccionadas.Select(e => new EspecificacionOrden
                {
                    EspecificacionId = e.Id,
                    Especificacion = e,
                    PrecioEspecificacion = e.PrecioAdicional
                }).ToList()
            };
            
            CarritoService.AgregarItem(item);
            CerrarPersonalizacion();
        }
    }

    private async Task ToggleFavorito(int productoId)
    {
        if (UsuarioService.UsuarioActual == null)
            return;

        if (productosFavoritos.Contains(productoId))
        {
            await UsuarioService.RemoverDeFavoritosAsync(UsuarioService.UsuarioActual.Id, productoId);
            productosFavoritos.Remove(productoId);
        }
        else
        {
            await UsuarioService.AgregarAFavoritosAsync(UsuarioService.UsuarioActual.Id, productoId);
            productosFavoritos.Add(productoId);
        }
    }
}
