@page "/register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.JSInterop
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Crear Cuenta - TechStore</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-icon">ğŸš€</div>
            <h1>Crear Cuenta</h1>
            <p>Ãšnete a TechStore hoy mismo</p>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert @(esError ? "alert-error" : "alert-success") @animarMensaje">
                <span class="alert-icon">@(esError ? "âš ï¸" : "âœ“")</span>
                <span>@mensaje</span>
            </div>
        }

        <EditForm Model="@registro" OnValidSubmit="HandleRegistro" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" />

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ‘¤</span>
                        <span>Nombre</span>
                    </label>
                    <InputText @bind-Value="registro.Nombre" 
                              class="form-input" 
                              placeholder="Tu nombre"
                              autocomplete="given-name" />
                    <ValidationMessage For="@(() => registro.Nombre)" class="validation-message" />
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">ğŸ‘¤</span>
                        <span>Apellido</span>
                    </label>
                    <InputText @bind-Value="registro.Apellido" 
                              class="form-input" 
                              placeholder="Tu apellido"
                              autocomplete="family-name" />
                    <ValidationMessage For="@(() => registro.Apellido)" class="validation-message" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ“§</span>
                    <span>Email</span>
                </label>
                <InputText @bind-Value="registro.Email" 
                          type="email" 
                          class="form-input" 
                          placeholder="tu@email.com"
                          autocomplete="email" />
                <ValidationMessage For="@(() => registro.Email)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ”’</span>
                    <span>ContraseÃ±a</span>
                </label>
                <InputText @bind-Value="registro.ContraseÃ±a" 
                          type="password" 
                          class="form-input" 
                          placeholder="MÃ­nimo 8 caracteres"
                          autocomplete="new-password" />
                <small class="form-hint">
                    Debe contener al menos una mayÃºscula, una minÃºscula y un nÃºmero
                </small>
                <ValidationMessage For="@(() => registro.ContraseÃ±a)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ”’</span>
                    <span>Confirmar ContraseÃ±a</span>
                </label>
                <InputText @bind-Value="registro.ContraseÃ±aConfirm" 
                          type="password" 
                          class="form-input" 
                          placeholder="Repite tu contraseÃ±a"
                          autocomplete="new-password" />
                <ValidationMessage For="@(() => registro.ContraseÃ±aConfirm)" class="validation-message" />
            </div>

            <button type="submit" class="btn-submit" disabled="@procesando">
                @if (procesando)
                {
                    <span class="spinner"></span>
                    <span>Creando cuenta...</span>
                }
                else
                {
                    <span class="btn-icon">âœ“</span>
                    <span>Crear Cuenta</span>
                }
            </button>
        </EditForm>

        <div class="auth-footer">
            <p>Â¿Ya tienes cuenta? <a href="/login" class="auth-link">Inicia sesiÃ³n â†’</a></p>
        </div>
    </div>

    <div class="auth-features">
        <div class="feature-item">
            <span class="feature-icon">ğŸ</span>
            <span>Ofertas exclusivas</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">ğŸ“¦</span>
            <span>Seguimiento de pedidos</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">â¤ï¸</span>
            <span>Lista de favoritos</span>
        </div>
    </div>
</div>

@code {
    private RegistroModel registro = new();
    private string mensaje = "";
    private bool esError = false;
    private bool procesando = false;
    private string animarMensaje = "";

    protected override void OnInitialized()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleRegistro()
    {
        procesando = true;
        mensaje = "";
        animarMensaje = "";

        try
        {
            var result = await JSRuntime.InvokeAsync<AuthResponse>("authFunctions.register",
                registro.Email,
                registro.Nombre,
                registro.Apellido,
                registro.ContraseÃ±a,
                registro.ContraseÃ±aConfirm);

            if (result?.Success == true)
            {
                mensaje = result.Message;
                esError = false;
                animarMensaje = "slide-in";
                await Task.Delay(1000);
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                mensaje = result?.Message ?? "Error al crear la cuenta";
                esError = true;
                animarMensaje = "shake";
            }
        }
        catch
        {
            mensaje = "Error de conexiÃ³n. Por favor intenta de nuevo.";
            esError = true;
            animarMensaje = "shake";
        }

        procesando = false;
    }

    private class AuthResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    public class RegistroModel
    {
        [Required(ErrorMessage = "El nombre es requerido")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "El nombre debe tener entre 2 y 50 caracteres")]
        public string Nombre { get; set; } = "";

        [Required(ErrorMessage = "El apellido es requerido")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "El apellido debe tener entre 2 y 50 caracteres")]
        public string Apellido { get; set; } = "";

        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "El formato del email no es vÃ¡lido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La contraseÃ±a es requerida")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "La contraseÃ±a debe tener al menos 8 caracteres")]
        public string ContraseÃ±a { get; set; } = "";

        [Required(ErrorMessage = "Debes confirmar tu contraseÃ±a")]
        [Compare("ContraseÃ±a", ErrorMessage = "Las contraseÃ±as no coinciden")]
        public string ContraseÃ±aConfirm { get; set; } = "";
    }
}
