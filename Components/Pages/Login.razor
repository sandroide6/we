@page "/login"
@using System.ComponentModel.DataAnnotations
@using Microsoft.JSInterop
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Iniciar Sesi√≥n - TechStore</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-icon">üîê</div>
            <h1>Iniciar Sesi√≥n</h1>
            <p>Bienvenido de vuelta a TechStore</p>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert @(esError ? "alert-error" : "alert-success") @animarMensaje">
                <span class="alert-icon">@(esError ? "‚ö†Ô∏è" : "‚úì")</span>
                <span>@mensaje</span>
            </div>
        }

        <EditForm Model="@login" OnValidSubmit="HandleLogin" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" />

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">üìß</span>
                    <span>Email</span>
                </label>
                <InputText @bind-Value="login.Email" 
                          class="form-input" 
                          placeholder="tu@email.com"
                          autocomplete="email" />
                <ValidationMessage For="@(() => login.Email)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">üîí</span>
                    <span>Contrase√±a</span>
                </label>
                <InputText @bind-Value="login.Contrase√±a" 
                          type="password" 
                          class="form-input" 
                          placeholder="Tu contrase√±a"
                          autocomplete="current-password" />
                <ValidationMessage For="@(() => login.Contrase√±a)" class="validation-message" />
            </div>

            <button type="submit" class="btn-submit" disabled="@procesando">
                @if (procesando)
                {
                    <span class="spinner"></span>
                    <span>Iniciando sesi√≥n...</span>
                }
                else
                {
                    <span class="btn-icon">‚úì</span>
                    <span>Iniciar Sesi√≥n</span>
                }
            </button>
        </EditForm>

        <div class="auth-footer">
            <p>¬øNo tienes cuenta? <a href="/register" class="auth-link">Crea una aqu√≠ ‚Üí</a></p>
        </div>
    </div>

    <div class="auth-features">
        <div class="feature-item">
            <span class="feature-icon">üõ°Ô∏è</span>
            <span>Seguro y encriptado</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">‚ö°</span>
            <span>Acceso instant√°neo</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">üéØ</span>
            <span>Compra r√°pida</span>
        </div>
    </div>
</div>

@code {
    private LoginModel login = new();
    private string mensaje = "";
    private bool esError = false;
    private bool procesando = false;
    private string animarMensaje = "";

    protected override void OnInitialized()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        procesando = true;
        mensaje = "";
        animarMensaje = "";

        try
        {
            var result = await JSRuntime.InvokeAsync<AuthResponse>("authFunctions.login", login.Email, login.Contrase√±a);

            if (result?.Success == true)
            {
                mensaje = result.Message;
                esError = false;
                animarMensaje = "slide-in";
                await Task.Delay(1000);
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                mensaje = result?.Message ?? "Error al iniciar sesi√≥n";
                esError = true;
                animarMensaje = "shake";
            }
        }
        catch
        {
            mensaje = "Error de conexi√≥n. Por favor intenta de nuevo.";
            esError = true;
            animarMensaje = "shake";
        }

        procesando = false;
    }

    private class AuthResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "El formato del email no es v√°lido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La contrase√±a es requerida")]
        [MinLength(6, ErrorMessage = "La contrase√±a debe tener al menos 6 caracteres")]
        public string Contrase√±a { get; set; } = "";
    }
}
