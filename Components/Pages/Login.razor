@page "/login"
@using System.ComponentModel.DataAnnotations
@inject UsuarioService UsuarioService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Iniciar SesiÃ³n - TechStore</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-icon">ğŸ”</div>
            <h1>Iniciar SesiÃ³n</h1>
            <p>Bienvenido de vuelta a TechStore</p>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert @(esError ? "alert-error" : "alert-success") @animarMensaje">
                <span class="alert-icon">@(esError ? "âš ï¸" : "âœ“")</span>
                <span>@mensaje</span>
            </div>
        }

        <EditForm Model="@login" OnValidSubmit="HandleLogin" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" />

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ“§</span>
                    <span>Email</span>
                </label>
                <InputText @bind-Value="login.Email" 
                          class="form-input" 
                          placeholder="tu@email.com"
                          autocomplete="email" />
                <ValidationMessage For="@(() => login.Email)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span class="label-icon">ğŸ”’</span>
                    <span>ContraseÃ±a</span>
                </label>
                <InputText @bind-Value="login.ContraseÃ±a" 
                          type="password" 
                          class="form-input" 
                          placeholder="Tu contraseÃ±a"
                          autocomplete="current-password" />
                <ValidationMessage For="@(() => login.ContraseÃ±a)" class="validation-message" />
            </div>

            <button type="submit" class="btn-submit" disabled="@procesando">
                @if (procesando)
                {
                    <span class="spinner"></span>
                    <span>Iniciando sesiÃ³n...</span>
                }
                else
                {
                    <span class="btn-icon">âœ“</span>
                    <span>Iniciar SesiÃ³n</span>
                }
            </button>
        </EditForm>

        <div class="auth-footer">
            <p>Â¿No tienes cuenta? <a href="/register" class="auth-link">Crea una aquÃ­ â†’</a></p>
        </div>
    </div>

    <div class="auth-features">
        <div class="feature-item">
            <span class="feature-icon">ğŸ›¡ï¸</span>
            <span>Seguro y encriptado</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">âš¡</span>
            <span>Acceso instantÃ¡neo</span>
        </div>
        <div class="feature-item">
            <span class="feature-icon">ğŸ¯</span>
            <span>Compra rÃ¡pida</span>
        </div>
    </div>
</div>

@code {
    private LoginModel login = new();
    private string mensaje = "";
    private bool esError = false;
    private bool procesando = false;
    private string animarMensaje = "";

    protected override async Task OnInitializedAsync()
    {
        if (UsuarioService.UsuarioActual != null)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        procesando = true;
        mensaje = "";
        animarMensaje = "";

        var (Ã©xito, msg) = await UsuarioService.LoginAsync(login.Email, login.ContraseÃ±a);

        if (Ã©xito)
        {
            mensaje = msg;
            esError = false;
            animarMensaje = "slide-in";
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/");
        }
        else
        {
            mensaje = msg;
            esError = true;
            animarMensaje = "shake";
        }

        procesando = false;
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "El formato del email no es vÃ¡lido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "La contraseÃ±a es requerida")]
        [MinLength(6, ErrorMessage = "La contraseÃ±a debe tener al menos 6 caracteres")]
        public string ContraseÃ±a { get; set; } = "";
    }
}
